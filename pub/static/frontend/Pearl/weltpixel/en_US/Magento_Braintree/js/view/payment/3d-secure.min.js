define(['jquery','braintree3DSecure','Magento_Braintree/js/view/payment/adapter','Magento_Checkout/js/model/quote','mage/translate','Magento_Ui/js/modal/modal','Magento_Checkout/js/model/full-screen-loader'],function($,braintree3DSecure,braintreeAdapter,quote,$t,Modal,fullScreenLoader){'use strict';return{config:null,modal:null,threeDSecureInstance:null,state:null,initialize:function(){var self=this,promise=$.Deferred();self.state=$.Deferred();braintreeAdapter.getApiClient().then(function(clientInstance){return braintree3DSecure.create({version:2,client:clientInstance});}).then(function(threeDSecureInstance){self.threeDSecureInstance=threeDSecureInstance;promise.resolve(self.threeDSecureInstance);}).catch(function(err){fullScreenLoader.stopLoader();promise.reject(err);});return promise.promise();},setConfig:function(config){this.config=config;this.config.thresholdAmount=parseFloat(config.thresholdAmount);},getCode:function(){return'three_d_secure';},validate:function(context){var self=this,totalAmount=quote.totals()['base_grand_total'],billingAddress=quote.billingAddress(),shippingAddress=quote.shippingAddress(),options={amount:totalAmount,nonce:context.paymentPayload.nonce,billingAddress:{givenName:billingAddress.firstname,surname:billingAddress.lastname,phoneNumber:billingAddress.telephone,streetAddress:billingAddress.street[0],extendedAddress:billingAddress.street[1],locality:billingAddress.city,region:billingAddress.regionCode,postalCode:billingAddress.postcode,countryCodeAlpha2:billingAddress.countryId},onLookupComplete:function(data,next){next();}};if(context.paymentPayload.details){options.bin=context.paymentPayload.details.bin;}
if(shippingAddress&&this.isValidShippingAddress(shippingAddress)){options.additionalInformation={shippingGivenName:shippingAddress.firstname,shippingSurname:shippingAddress.lastname,shippingPhone:shippingAddress.telephone,shippingAddress:{streetAddress:shippingAddress.street[0],extendedAddress:shippingAddress.street[1],locality:shippingAddress.city,region:shippingAddress.regionCode,postalCode:shippingAddress.postcode,countryCodeAlpha2:shippingAddress.countryId}};}
if(!this.isAmountAvailable(totalAmount)||!this.isCountryAvailable(billingAddress.countryId)){self.state=$.Deferred();self.state.resolve();return self.state.promise();}
fullScreenLoader.startLoader();this.initialize().then(function(){self.threeDSecureInstance.verifyCard(options,function(err,payload){if(err){fullScreenLoader.stopLoader();self.state.reject(err.message);return;}
if(payload.liabilityShifted||!payload.liabilityShifted&&!payload.liabilityShiftPossible){context.paymentPayload.nonce=payload.nonce;self.state.resolve();}else{fullScreenLoader.stopLoader();self.state.reject($t('Please try again with another form of payment.'));}});}).fail(function(){fullScreenLoader.stopLoader();self.state.reject($t('Please try again with another form of payment.'));});return self.state.promise();},isAmountAvailable:function(amount){amount=parseFloat(amount);return amount>=this.config.thresholdAmount;},isCountryAvailable:function(countryId){var key,specificCountries=this.config.specificCountries;if(!specificCountries.length){return true;}
for(key in specificCountries){if(countryId===specificCountries[key]){return true;}}
return false;},isValidShippingAddress:function(shippingAddress){var isValid=false;if(shippingAddress.firstname&&shippingAddress.lastname&&shippingAddress.telephone&&shippingAddress.street&&shippingAddress.city&&shippingAddress.regionCode&&shippingAddress.postcode&&shippingAddress.countryId){isValid=true;}
return isValid;}};});