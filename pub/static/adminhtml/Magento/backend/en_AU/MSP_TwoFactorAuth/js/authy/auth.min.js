'use strict';define(['jquery','ko','uiComponent','MSP_TwoFactorAuth/js/error','MSP_TwoFactorAuth/js/registry','mage/translate'],function($,ko,Component,error,registry){return Component.extend({selectedMethod:ko.observable(''),waitingText:ko.observable(''),success:ko.observable(false),tokenCode:ko.observable(''),trustThisDevice:registry.trustThisDevice,defaults:{template:'MSP_TwoFactorAuth/authy/auth'},waitForOneTouchApprovalTimeout:0,postUrl:'',tokenRequestUrl:'',oneTouchUrl:'',verifyOneTouchUrl:'',getPostUrl:function(){return this.postUrl;},getTokenRequestUrl:function(){return this.tokenRequestUrl;},getOneTouchUrl:function(){return this.oneTouchUrl;},getVerifyOneTouchUrl:function(){return this.verifyOneTouchUrl;},getSuccessUrl:function(){return this.successUrl;},login:function(){this.success(true);self.location.href=this.getSuccessUrl();},stopWaitingOnetouchApproval:function(){if(this.waitForOneTouchApprovalTimeout){window.clearTimeout(this.waitForOneTouchApprovalTimeout);this.waitForOneTouchApprovalTimeout=0;}},runSendCode:function(via){var me=this;this.selectedMethod('code');if(via!=='token'){$.getJSON(this.getTokenRequestUrl()+'?via='+
via+'&tfa_trust_device='+(me.trustThisDevice()?1:0)).fail(function(){error.display('There was an error trying to contact Authy services');me.switchAnotherMethod();});}},runSendCodeToken:function(){this.runSendCode('token');},runSendCodeSms:function(){this.runSendCode('sms');},runSendCodeCall:function(){this.runSendCode('call');},runOneTouch:function(){var me=this;this.selectedMethod('onetouch');this.waitingText('Sending push notification...');this.success(false);this.stopWaitingOnetouchApproval();$.getJSON(this.getOneTouchUrl()+'?tfa_trust_device='+(me.trustThisDevice()?1:0)).done(function(){me.waitForOneTouchApproval();}).fail(function(){error.display('There was an error trying to contact Authy services');me.switchAnotherMethod();});},waitForOneTouchApproval:function(){var me=this;this.waitingText('Waiting for approval...');$.getJSON(this.getVerifyOneTouchUrl()).done(function(res){if(res.status==='retry'){me.waitForOneTouchApprovalTimeout=window.setTimeout(function(){me.waitForOneTouchApproval();},1000);}else if(res.status==='expired'){error.display($.mage.__('Your request has been expired'));me.switchAnotherMethod();}else if(res.status==='denied'){error.display($.mage.__('Your request has been rejected'));me.switchAnotherMethod();}else if(res.status==='approved'){me.login();}}).fail(function(){error.display('There was an error trying to contact Authy services');this.switchAnotherMethod();});},switchAnotherMethod:function(){this.selectedMethod('');this.waitingText('');this.success(false);},verifyCode:function(){var me=this;this.waitingText('Please wait...');$.post(this.getPostUrl(),{'tfa_code':this.tokenCode}).done(function(res){if(res.success){me.login();}else{error.display(res.message);me.waitingText('');me.tokenCode('');}}).fail(function(){error.display('There was an internal error trying to verify your code');});}});});